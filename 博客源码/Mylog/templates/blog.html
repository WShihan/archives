{% extends 'template.html' %}
{% from 'macro.html' import comment  %}
{% from 'macro.html' import upper  %}

{% block header %}
    <style class="inner-code">
        {{ 'code.css' | inner_css | safe }}
    </style>
{% endblock header %}

{% block content %}
    <!-- ÂçöÂÆ¢‰ø°ÊÅØ -->
    <h1 class="blog-title">{{ blog.title }}</h1>
    <div class="blog-info tip">
        <span class="publish">ÂèëÂ∏É:&nbsp;{{blog.time.strftime('%Y-%m-%d')}}</span>
        {% if blog.update %}
            <span class="update">‰øÆÊîπ:&nbsp;{{blog.update.strftime('%Y-%m-%d')}}</span>
        {% endif %}
        {% if blog.comments|length > 0 %}
            <span class="comment-num">ÂõûÂ§ç:&nbsp;{{ blog.comments | length}} Êù°</span>
        {% endif %}
        <span class="category">ËØùÈ¢ò:&nbsp;#{{ blog.category }}#</span>
    </div>

    <br>
    <!-- Â§áÊ≥® -->
    {% if blog.note %}
        <div class="note">
            <div class="icon">
                <span>üìé</span>
            </div>
            <div class="note-body">
                 <p class="note-text">{{ blog.note }} </p>
            </div>
        </div>
        <br>
    {% endif %}
    <!-- ÂçöÂÆ¢ÂÜÖÂÆπÂå∫ -->
    <!-- üëÄ -->
    <div class="content content-text markdown-body" id="blog-body">
        <br>
        {{ blog.body | md2html | safe }}
    </div>

    {{ upper() }}
    {% if blog.commentable %}
        <!-- ËøôÊòØÁïôË®ÄÂå∫ -->
        <!-- üîñ üëâ ü§° -->
         {% if blog.comments %}
            <div class="comments" >
                {% for cmt in blog.comments %}
                    {% if cmt.audit %}
                        <div class="comment" >
                            <div class="cmt-item user">
                                <span>
                                    {% if cmt.parent %}
                                        <span ><strong>{{cmt.nickname }}</strong></span> ÂõûÂ§ç <strong>{{cmt.parent.nickname}}&nbsp;&nbsp;</strong>ËØ¥</span>
                                    {% else %}
                                    <span ><strong>{{cmt.nickname }}</strong>&nbsp;ËØ¥</span></span>
                                    {% endif%}
                                <span>
                                    {{ moment(cmt.time).fromNow() }}&nbsp;&nbsp;
                                    {% if cmt.site %}
                                        <span title="ÂâçÂæÄËØÑËÆ∫ËÄÖÁ´ôÁÇπ„ÄÇ">
                                            <a href="{{ cmt.site }}" target="_blank" class="icon-link">üåê</a>&nbsp;&nbsp;&nbsp;&nbsp;
                                        </span>
                                    {% endif %}
                                    <span class="reply-btn" title="ÂõûÂ§ç{{ cmt.nickname }}" 
                                    data-reply-id="{{ cmt.id }}" 
                                    data-reply-nickname="{{ cmt.nickname }}"
                                    onclick="makeReply(event)"
                                    >‚û•</span>
                                </span>
                            </div>
                            <div class="cmt-item body">
                                <span>{{ cmt.body | md2html | safe }}</span>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
        <!-- ËøôÈáåÊòØÁïôË®ÄÊùøÂùó -->
        <!-- üòÄ üëâ ü§° -->
         
        <div class="board" >
            <div class="form-inner" >
                <div class="form-item">
                    <label class="required" for="comment">*&nbsp;</label>
                    <textarea class="board-item textarea " id="comment"  placeholder="ÁïôË®ÄÊñáÊú¨ÂÜÖÂÆπ" name="comment" id="cmt" cols="30" rows="10"></textarea>
                </div>
                <div class="form-item">
                    <details>
                        <summary>ÈÄâÂ°´ÂÜÖÂÆπ</summary>
                        <div class="detail-body">
                            <div class="form-item">
                                <label for="nickname">ÊòµÁß∞&nbsp;</label>
                                <input class="nickname board-item " id="nickname"  type="text"  placeholder="ÊÑøÊÑèÁöÑËØùÂèØ‰ª•Áïô‰∏ã‰∏Ä‰∏™ÊòµÁß∞">
                            </div>
                            <div class="form-item">
                                <label for="email">ÈÇÆÁÆ±&nbsp;</label>
                                <input class="email board-item " id="email" type="text"  placeholder="ÂΩìÊúâÂõûÂ§çÊó∂ÈÄöÁü•Ôºå‰∏ç‰ºöÊ≥ÑÈú≤">
                            </div>
                            <div class="form-item">
                                <label for="site">Á´ôÁÇπ&nbsp;</label>
                                <input class="site board-item " id="site" type="text"  placeholder="ÊÑøÊÑèÁöÑËØùÂèØ‰ª•Áïô‰∏ãËá™Â∑±ÁöÑÁ´ôÁÇπÈìæÊé•">
                            </div>
                        </div>
                    </details>
                </div>
                <input class="csrf board-item" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}" type="hidden">
                <input class="id board-item" id="blogid" value="{{ blog.id }}" type="hidden">
                <input class="replyid board-item" id="replyid" name="replyid" value="" type="hidden" >
                <input class="title board-item" id="blogtitle" value="{{ blog.title }}" type="hidden">
                <button class="submit icon" type="submit" id="cmt-submit">Êèê‰∫§</button>
            </div>
        </div>
    {% endif %}
    <script src="/static/js/mermaid.js" ></script>
    <link rel="stylesheet" href="/static/css/highlight.css">
    <script src="/static/js/highlight.js" ></script>

    <script defer src="/static/js/nprogress-0.2.0.js"></script>
    <link rel="stylesheet" href="/static/css/nprogress.css">
    <!-- Ê∏≤Êüì‰ª£Á†ÅÂíåÂõæË°® -->
    <script defer>
        mermaid.initialize({ startOnLoad: true });
        hljs.highlightAll();
    </script>
    <script defer>
        /* ÂõûÂ§çÂä®‰Ωú */
        function makeReply(event) {
            let element = event.target;
            let replyId = element.getAttribute('data-reply-id');
            let replyNickname = element.getAttribute('data-reply-nickname');
            let replyIdInputEle = document.getElementById('replyid');
            replyIdInputEle.value = replyId
            document.getElementById('comment').value = `@${ replyNickname } `;
        }
    
        const cmtBtnEle = document.getElementById('cmt-submit')
        cmtBtnEle.onclick = submitCmt
        /* ÁïôË®Ä */
        function submitCmt(){
            const nickname = document.getElementById('nickname').value
            const email = document.getElementById('email').value
            const site = document.getElementById('site').value
            const comment = document.getElementById('comment').value
            const csrf_token = document.getElementById('csrf_token').value
            const blogid = document.getElementById('blogid').value
            const replyid = document.getElementById('replyid').value
            const blogtitle = document.getElementById('blogtitle').value
            if (comment == ''){
                alert('ËØ∑Â°´ÂÜôËØÑËÆ∫ÂÜÖÂÆπ')
                return
            }
            const payload = {
                nickname,
                email,
                site,
                comment,
                csrf_token,
                blogid,
                replyid,
                blogtitle
            }

            NProgress.start()
            cmtBtnEle.style.display = 'none'
            fetch('/mylog/comment/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token,
                },
                body: JSON.stringify(payload)
            }).then(res => res.json()).then(res => {
                if (res.status){
                    celebrate()
                    setTimeout(() =>{
                        location.reload()
                    }, 3000)
                }else{
                    alert(`Âá∫Èîô‰∫ÜÔºö${res.msg}`)
                    console.error(res)
                }
            }).catch(err =>{
                alert(`Âá∫Èîô‰∫ÜÔºö${err}`)
                console.error(err)
            })
            .finally(() =>{
                NProgress.done()
                cmtBtnEle.style.display = 'block'
            })

        }
                    
    </script>
    <!-- ÁõÆÂΩïÁº©Â±ï -->
    <script>
        const tocs = document.getElementsByClassName('toc');

        if (tocs.length != 0){
            const tocEle = tocs[0]; 
            const tocSwitch = document.getElementById('toc-switch')
            function collapse(){
                tocEle.classList.remove('active')
                tocSwitch.classList.add('active')
                tocSwitch.setAttribute('data-collapse', 'false')
            }
            function uncollapse(){
                tocEle.classList.add('active')
                tocEle.classList.remove('uncollapse')
                tocSwitch.classList.remove('active')
                tocSwitch.setAttribute('data-collapse', 'true')
            }
            // Â±èÂπïÂ§ß‰∫é1024ÔºåÈªòËÆ§ÂºÄÂêØÁõÆÂΩï
            if(window.screen.width > 1023){
                uncollapse()
            }
            tocSwitch.addEventListener('click', (evt) => {
                if (evt.currentTarget.getAttribute('data-collapse') == 'true') {
                    collapse()
                } else{
                    uncollapse()
                }
            })
            // ÁõÆÂΩïÊèêÁ§∫ÂΩìÂâçÊµèËßàÁ´†ËäÇ
            window.addEventListener('DOMContentLoaded', () => {
            const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                const id = entry.target.getAttribute('id');
                if (entry.intersectionRatio > 0) {
                document
                    .querySelector(`div.toc ul li a[href="#${id}"]`)
                    .parentElement.classList.add('active');
                } else {
                document
                    .querySelector(`div.toc ul li a[href="#${id}"]`)
                    .parentElement.classList.remove('active');
                }
            });
            });
            document.querySelectorAll('section[id]').forEach(sectionEle => {
                observer.observe(sectionEle);
            });
        });
        }

    </script>
    <script defer>
        document.getElementById('blog-body').addEventListener('click', function(event) {
            if (event.target.classList.contains('code-copy')) {
                const codeEle = event.target.parentElement.parentElement.getElementsByTagName('code')[0];
                const code = codeEle.innerText;
                navigator.clipboard.writeText(code).then(function() {
                    event.target.innerText = 'Â∑≤Â§çÂà∂'
                    // 10sÂêéÊÅ¢Â§ç„ÄêÂ§çÂà∂„ÄëÊåâ‰Ω†
                    setTimeout(() =>{
                        event.target.innerText = 'Â§çÂà∂'
                    }, 10000)
                }).catch(function(error) {
                    console.error('Â§çÂà∂Â§±Ë¥•:', error);
                });
            }
        });
    </script>
{% endblock %}
